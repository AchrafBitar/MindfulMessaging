var l=Object.defineProperty;var i=(a,e,t)=>e in a?l(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var c=(a,e,t)=>i(a,typeof e!="symbol"?e+"":e,t);class m{constructor(){c(this,"platforms",{whatsapp:{selectors:['div[role="row"] .copyable-text',".message-in .selectable-text",".message-out .selectable-text",'[data-testid="conversation-message"] .selectable-text'],name:"WhatsApp Web"},messenger:{selectors:['[data-testid="message_bubble"] .text-content',".uiScrollableArea ._5yl5",'[role="main"] ._1p1t'],name:"Facebook Messenger"},gmail:{selectors:[".zA .zF .yP",".gmail_default .yW",'[role="main"] .zA .zF'],name:"Gmail"},slack:{selectors:[".c-message__body",".c-message_kit__text",'[data-qa="message_text"]'],name:"Slack"},telegram:{selectors:[".message .text",".bubble .text","[data-peer-id] .text"],name:"Telegram Web"}});c(this,"currentPlatform","");c(this,"observer",null);this.detectPlatform(),this.setupMessageListeners(),this.setupMutationObserver()}detectPlatform(){const e=window.location.hostname;e.includes("web.whatsapp.com")?this.currentPlatform="whatsapp":e.includes("messenger.com")||e.includes("facebook.com")?this.currentPlatform="messenger":e.includes("mail.google.com")?this.currentPlatform="gmail":e.includes("app.slack.com")?this.currentPlatform="slack":e.includes("web.telegram.org")?this.currentPlatform="telegram":this.currentPlatform="generic",console.log(`Mindful: Detected platform: ${this.currentPlatform}`)}setupMessageListeners(){chrome.runtime.onMessage.addListener((e,t,r)=>{try{e.type==="ANALYZE_TEXT"&&(this.handleAnalyzeRequest(e.payload),r({success:!0}))}catch(s){console.error("Mindful: Error handling message:",s);const n=s instanceof Error?s.message:"Unknown error";r({success:!1,error:n})}return!0}),document.addEventListener("click",()=>{setTimeout(()=>{this.extractLatestMessages()},100)})}setupMutationObserver(){this.observer=new MutationObserver(e=>{e.forEach(t=>{t.type==="childList"&&t.addedNodes.forEach(r=>{if(r.nodeType===Node.ELEMENT_NODE){const s=r;this.isMessageElement(s)&&this.extractMessageFromElement(s)}})})}),this.observer.observe(document.body,{childList:!0,subtree:!0})}isMessageElement(e){const t=this.platforms[this.currentPlatform];return t?t.selectors.some(r=>{try{return e.matches(r)||e.querySelector(r)}catch{return!1}}):!1}extractMessageFromElement(e){const t=this.extractMessageData(e);t&&t.text.trim()&&(console.log("Mindful: Detected new message:",t),this.sendToBackground(t))}extractMessageData(e){const t=this.platforms[this.currentPlatform];if(!t)return null;let r="",s="";for(const n of t.selectors)try{const o=e.querySelector(n)||(e.matches(n)?e:null);if(o){r=o.textContent||o.innerText||"";break}}catch(o){console.warn("Mindful: Error extracting text with selector:",n,o)}return s=this.extractSender(e),r.trim()?{text:r.trim(),platform:t.name,timestamp:Date.now(),sender:s}:null}extractSender(e){var r;const t=['[data-testid="conversation-title"]',".chat-title",".sender-name",".author",'[data-qa="message_sender"]'];for(const s of t)try{const n=e.querySelector(s)||e.closest(s);if(n)return((r=n.textContent)==null?void 0:r.trim())||""}catch{continue}return""}extractLatestMessages(){if(!this.platforms[this.currentPlatform])return;const t=[];this.getRecentMessageElements().forEach(s=>{const n=this.extractMessageData(s);n&&n.text.trim()&&t.push(n)}),t.length>0&&(console.log("Mindful: Extracted recent messages:",t),this.sendToBackground(t[t.length-1]))}getRecentMessageElements(){const e=this.platforms[this.currentPlatform];if(!e)return[];const t=[];return e.selectors.forEach(r=>{try{const s=document.querySelectorAll(r);t.push(...Array.from(s))}catch{}}),[...new Set(t)]}handleAnalyzeRequest(e){try{const{text:t,contextId:r}=e,s=this.extractPageContext();chrome.runtime.sendMessage({type:"ANALYZE_TEXT",payload:{text:t,contextId:r,context:s}}).catch(n=>{console.log("Mindful: Failed to send analysis request to background:",n)})}catch(t){console.error("Mindful: Error handling analyze request:",t)}}extractPageContext(){const e={platform:this.currentPlatform,url:window.location.href,title:document.title,timestamp:Date.now()};switch(this.currentPlatform){case"whatsapp":e.conversation=this.extractWhatsAppContext();break;case"messenger":e.conversation=this.extractMessengerContext();break;case"gmail":e.email=this.extractGmailContext();break;case"slack":e.channel=this.extractSlackContext();break}return e}extractWhatsAppContext(){var t;const e=document.querySelector('[data-testid="conversation-title"]');return{contact:((t=e==null?void 0:e.textContent)==null?void 0:t.trim())||"Unknown Contact",type:"chat"}}extractMessengerContext(){var t;const e=document.querySelector('[data-testid="conversation-title"]')||document.querySelector(".chat-title");return{contact:((t=e==null?void 0:e.textContent)==null?void 0:t.trim())||"Unknown Contact",type:"chat"}}extractGmailContext(){var r,s;const e=document.querySelector("[data-thread-perm-id] h2")||document.querySelector(".hP"),t=document.querySelector(".gD");return{subject:((r=e==null?void 0:e.textContent)==null?void 0:r.trim())||"No Subject",sender:((s=t==null?void 0:t.textContent)==null?void 0:s.trim())||"Unknown Sender",type:"email"}}extractSlackContext(){var t;const e=document.querySelector('[data-qa="channel_name"]')||document.querySelector(".p-channel_sidebar__channel");return{channel:((t=e==null?void 0:e.textContent)==null?void 0:t.trim())||"Unknown Channel",type:"chat"}}sendToBackground(e){try{chrome.runtime.sendMessage({type:"ANALYZE_TEXT",payload:{text:e.text,platform:e.platform,sender:e.sender,timestamp:e.timestamp}}).catch(t=>{console.log("Mindful: Background script not available:",t)})}catch(t){console.log("Mindful: Failed to send message to background:",t)}}getSelectedText(){const e=window.getSelection();return(e==null?void 0:e.toString().trim())||null}destroy(){this.observer&&this.observer.disconnect()}}const u=new m;window.mindfulMessageDetector=u;
